apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: streamspace-platform
  namespace: streamspace
  annotations:
    # SECURITY: Force HTTPS
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    # SECURITY: Redirect HTTP to HTTPS
    traefik.ingress.kubernetes.io/redirect-scheme: https
    traefik.ingress.kubernetes.io/redirect-permanent: "true"
    # SECURITY: Enable HSTS
    traefik.ingress.kubernetes.io/hsts-max-age: "31536000"
    traefik.ingress.kubernetes.io/hsts-include-subdomains: "true"
    traefik.ingress.kubernetes.io/hsts-preload: "true"
    # Enable cert-manager for automatic TLS certificate management
    cert-manager.io/cluster-issuer: letsencrypt-prod
    # Optional: Enable Authentik/Keycloak SSO protection
    # traefik.ingress.kubernetes.io/router.middlewares: authentik-forwardauth@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - streamspace.local
        - "*.streamspace.local"
      secretName: streamspace-platform-tls
  rules:
    # Main UI and API
    - host: streamspace.local
      http:
        paths:
          # API endpoints
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: streamspace-api
                port:
                  number: 8000
          # Webhooks
          - path: /webhooks
            pathType: Prefix
            backend:
              service:
                name: streamspace-api
                port:
                  number: 8000
          # UI (catch-all)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: streamspace-ui
                port:
                  number: 80
---
# Session ingress (dynamically managed by controller)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: streamspace-sessions
  namespace: streamspace
  annotations:
    # SECURITY: Force HTTPS for session access
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/redirect-scheme: https
    traefik.ingress.kubernetes.io/redirect-permanent: "true"
    # This ingress will be dynamically updated by the controller
    # to route *.streamspace.local to individual session pods
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - "*.streamspace.local"
      secretName: streamspace-sessions-tls
  rules:
    # Example session route (controller will add more dynamically)
    # - host: user1-firefox.streamspace.local
    #   http:
    #     paths:
    #       - path: /
    #         pathType: Prefix
    #         backend:
    #           service:
    #             name: ss-user1-firefox-svc
    #             port:
    #               number: 3000
